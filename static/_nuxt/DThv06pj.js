import{x as m,w as g,y as n,z as y,b as k,A as v,e as f,l as h,B as T,C,E as S,d as $,F as w,G as b,D as A,L as u,H as D}from"./BGsF8phL.js";import{R as E}from"./sKL9cp8e.js";let o=null,c=[],d=[];function l(){return o??(o=new AudioContext)}function x(){const e=l(),t=e.createGain();return t.connect(e.destination),c.push(t),t}function G(e,t){const i=l(),s=i.createMediaElementSource(e);return t&&s.connect(t),d.push(s),s}function B(e){const t=c.indexOf(e);t!==-1&&(c.splice(t,1),e.disconnect(),p())}function P(e){const t=d.indexOf(e);t!==-1&&(d.splice(t,1),e.disconnect(),p())}function p(){o&&c.length===0&&d.length===0&&o.close().then(()=>{o=null})}class R{constructor(t,i){this.a=t,this.B=i,this.Cn=null,this.Dn=null}get currentGain(){var t,i;return((i=(t=this.Cn)==null?void 0:t.gain)==null?void 0:i.value)??null}get supported(){return!0}setGain(t){const i=this.currentGain;if(t!==this.currentGain){if(t===1&&i!==1){this.removeGain();return}this.Cn||(this.Cn=x(),this.Dn&&this.Dn.connect(this.Cn)),this.Dn||(this.Dn=G(this.a,this.Cn)),this.Cn.gain.value=t,this.B(t)}}removeGain(){this.Cn&&(this.Dn&&this.Dn.connect(l().destination),this.En(),this.B(null))}destroy(){this.Fn(),this.En()}Fn(){if(this.Dn)try{P(this.Dn)}catch{}finally{this.Dn=null}}En(){if(this.Cn)try{B(this.Cn)}catch{}finally{this.Cn=null}}}class F{constructor(t,i){this.i=t,this.b=i,this.sa=v(),this.Cb=!1,this.$c=!1,this.ad=!1,this.Da=new E(this.bd.bind(this)),this.Qe=void 0,this.Dg=void 0,this.pg(),f(this.qg.bind(this)),g(this.cd.bind(this))}get a(){return this.i.media}get c(){return this.b.delegate.c}cd(){this.$c=!1,this.ad=!1,this.Da.ra(),this.sa.empty()}bd(){const t=this.a.currentTime;this.b.$state.realCurrentTime()!==t&&this.$a(t)}pg(){this.t("loadstart",this.Ea),this.t("abort",this.Pe),this.t("emptied",this.rg),this.t("error",this.U),this.t("volumechange",this.ab)}sg(){this.$c||(this.sa.add(this.t("loadeddata",this.tg),this.t("loadedmetadata",this.ug),this.t("canplay",this.hc),this.t("canplaythrough",this.vg),this.t("durationchange",this.wg),this.t("play",this.xb),this.t("progress",this.ic),this.t("stalled",this.xg),this.t("suspend",this.yg),this.t("ratechange",this.Bg)),this.$c=!0)}zg(){this.ad||(this.sa.add(this.t("pause",this.Aa),this.t("playing",this.Ag),this.t("seeked",this.bb),this.t("seeking",this.Cg),this.t("ended",this.Db),this.t("waiting",this.dd)),this.ad=!0)}t(t,i){return h(this.a,t,i.bind(this))}Eg(t){}$a(t,i){const s={currentTime:Math.min(t,this.b.$state.seekableEnd()),played:this.a.played};this.c("time-update",s,i)}Ea(t){if(this.a.networkState===3){this.Pe(t);return}this.sg(),this.c("load-start",void 0,t)}Pe(t){this.c("abort",void 0,t)}rg(){this.c("emptied",void 0,event)}tg(t){this.c("loaded-data",void 0,t)}ug(t){this.zg(),this.c("loaded-metadata",void 0,t),(T||C&&S(this.b.$state.source()))&&this.b.delegate.jc(this.ed(),t)}ed(){return{provider:$(this.b.$provider),duration:this.a.duration,buffered:this.a.buffered,seekable:this.a.seekable}}xb(t){this.b.$state.canPlay&&this.c("play",void 0,t)}Aa(t){this.a.readyState===1&&!this.Cb||(this.Cb=!1,this.Da.ra(),this.c("pause",void 0,t))}hc(t){this.b.delegate.jc(this.ed(),t)}vg(t){this.b.$state.started()||this.c("can-play-through",this.ed(),t)}Ag(t){this.Cb=!1,this.c("playing",void 0,t),this.Da.Bb()}xg(t){this.c("stalled",void 0,t),this.a.readyState<3&&(this.Cb=!0,this.c("waiting",void 0,t))}dd(t){this.a.readyState<3&&(this.Cb=!0,this.c("waiting",void 0,t))}Db(t){this.Da.ra(),this.$a(this.a.duration,t),this.c("end",void 0,t),this.b.$state.loop()&&w(this.a.controls)&&(this.a.controls=!1)}qg(){this.b.$state.paused()&&h(this.a,"timeupdate",this.Eb.bind(this))}Eb(t){this.$a(this.a.currentTime,t)}wg(t){this.b.$state.ended()&&this.$a(this.a.duration,t),this.c("duration-change",this.a.duration,t)}ab(t){const i={volume:this.a.volume,muted:this.a.muted};this.c("volume-change",i,t)}bb(t){this.$a(this.a.currentTime,t),this.c("seeked",this.a.currentTime,t),Math.trunc(this.a.currentTime)===Math.trunc(this.a.duration)&&b(this.a.duration)>b(this.a.currentTime)&&(this.$a(this.a.duration,t),this.a.ended||this.b.player.dispatch(new A("media-play-request",{trigger:t})))}Cg(t){this.c("seeking",this.a.currentTime,t)}ic(t){const i={buffered:this.a.buffered,seekable:this.a.seekable};this.c("progress",i,t)}yg(t){this.c("suspend",void 0,t)}Bg(t){this.c("rate-change",this.a.playbackRate,t)}U(t){const i=this.a.error;if(!i)return;const s={message:i.message,code:i.code,mediaError:i};this.c("error",s,t)}}class I{constructor(t,i){this.i=t,this.b=i,this.Fb.onaddtrack=this.Fg.bind(this),this.Fb.onremovetrack=this.Gg.bind(this),this.Fb.onchange=this.Hg.bind(this),h(this.b.audioTracks,"change",this.Ig.bind(this))}get Fb(){return this.i.media.audioTracks}Fg(t){const i=t.track;if(i.label==="")return;const s=i.id.toString()||`native-audio-${this.b.audioTracks.length}`,a={id:s,label:i.label,language:i.language,kind:i.kind,selected:!1};this.b.audioTracks[u.oa](a,t),i.enabled&&(a.selected=!0)}Gg(t){const i=this.b.audioTracks.getById(t.track.id);i&&this.b.audioTracks[u.Yb](i,t)}Hg(t){let i=this.Re();if(!i)return;const s=this.b.audioTracks.getById(i.id);s&&this.b.audioTracks[u.pa](s,!0,t)}Re(){return Array.from(this.Fb).find(t=>t.enabled)}Ig(t){const{current:i}=t.detail;if(!i)return;const s=this.Fb.getTrackById(i.id);if(s){const a=this.Re();a&&(a.enabled=!1),s.enabled=!0}}}class O{constructor(t,i){this.a=t,this.b=i,this.scope=m(),this.V=null,this.audioGain=new R(this.a,s=>{this.b.delegate.c("audio-gain-change",s)})}setup(){new F(this,this.b),"audioTracks"in this.media&&new I(this,this.b),g(()=>{this.audioGain.destroy(),this.a.srcObject=null,this.a.removeAttribute("src");for(const t of this.a.querySelectorAll("source"))t.remove();this.a.load()})}get type(){return""}get media(){return this.a}get currentSrc(){return this.V}setPlaybackRate(t){this.a.playbackRate=t}async play(){return this.a.play()}async pause(){return this.a.pause()}setMuted(t){this.a.muted=t}setVolume(t){this.a.volume=t}setCurrentTime(t){this.a.currentTime=t}setPlaysInline(t){n(this.a,"playsinline",t)}async loadSource({src:t,type:i},s){this.a.preload=s||"",y(t)?(this.Bn(),this.a.srcObject=t):(this.a.srcObject=null,k(t)?i!=="?"?this.yn({src:t,type:i}):(this.Bn(),this.a.src=this.Ik(t)):(this.Bn(),this.a.src=window.URL.createObjectURL(t))),this.a.load(),this.V={src:t,type:i}}yn(t,i){const s=this.a.querySelector("source[data-vds]"),a=s??document.createElement("source");n(a,"src",this.Ik(t.src)),n(a,"type",t.type!=="?"?t.type:i),n(a,"data-vds",""),s||this.a.append(a)}Bn(){var t;(t=this.a.querySelector("source[data-vds]"))==null||t.remove()}Ik(t){const{clipStartTime:i,clipEndTime:s}=this.b.$state,a=i(),r=s();return a>0&&r>0?`${t}#t=${a},${r}`:a>0?`${t}#t=${a}`:r>0?`${t}#t=0,${r}`:t}}class M{constructor(t,i){this.a=t,this.b=i,this.Se=D(!1),this.Hm()}get supported(){return this.Se()}Hm(){var t;!((t=this.a)!=null&&t.remote)||!this.sl||(this.a.remote.watchAvailability(i=>{this.Se.set(i)}).catch(()=>{this.Se.set(!1)}),f(this.rn.bind(this)))}rn(){if(!this.Se())return;const t=["connecting","connect","disconnect"],i=this.Rg.bind(this);i(),h(this.a,"playing",i);for(const s of t)h(this.a.remote,s,i)}async prompt(){if(!this.supported)throw Error("Not supported on this platform.");return this.vb==="airplay"&&this.a.webkitShowPlaybackTargetPicker?this.a.webkitShowPlaybackTargetPicker():this.a.remote.prompt()}Rg(t){const i=this.a.remote.state;if(i===this.mc)return;const s={type:this.vb,state:i};this.b.delegate.c("remote-playback-change",s,t),this.mc=i}}class N extends M{constructor(){super(...arguments),this.vb="airplay"}get sl(){return"WebKitPlaybackTargetAvailabilityEvent"in window}}export{O as H,N as a};
